<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aptitude Test ‚Äì Results</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef2f3;
            padding: 30px;
        }
        .container {
            width: 60%;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
        }
        .score-box {
            margin-top: 20px;
            background: #f7fff4;
            padding: 20px;
            border-left: 6px solid green;
        }
        .btn {
            margin-top: 20px;
            padding: 12px 20px;
            background: #4CAF50;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            opacity: 0.9;
        }

        /* Hide canvas (used only for PDF chart) */
        #chartCanvas {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Full Aptitude Report</h2>
    <h3 id="studentInfo"></h3>

    <div id="resultSection" class="score-box">
        Loading results...
    </div>

    <!-- <button class="btn" onclick="window.location.href='tests/aptitude.html'">
        Retake Test
    </button> -->
    <button class="btn" onclick="resetAndRetake()">
    Retake Test
    </button>

    <button class="btn" onclick="downloadPDF()">
        Download PDF
    </button>
</div>

<!-- Hidden canvas for chart -->
<canvas id="chartCanvas" width="400" height="300"></canvas>

<script>


// LOAD STUDENT INFO
    let name = localStorage.getItem("student_name");
    let studentClass = localStorage.getItem("student_class");

    if (name && studentClass) {
        document.getElementById("studentInfo").innerHTML =
            `Name: <b>${name}</b><br>Class: <b>${studentClass}</b>`;
    } else {
        document.getElementById("studentInfo").innerHTML =
            "Student details not found";
    }

    
    // üî• FIREBASE CONFIG (PASTE YOUR OWN DETAILS)
    const firebaseConfig = {
        apiKey: "AIzaSyDmPuS8qdcVk3tOT0otxhQwXyABL5KdUpI",
        authDomain: "career-counselling-site-cbe7a.firebaseapp.com",
        projectId: "career-counselling-site-cbe7a",
        storageBucket: "career-counselling-site-cbe7a.firebasestorage.app",
        messagingSenderId: "618623222390",
        appId: "1:618623222390:web:92a94e147560dfc9f85557",
        measurementId: "G-1DGXL8YTKH"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Initialize Firestore
    const db = firebase.firestore();
    
 async function saveResultToDB(total, categories) {

    // ‚ùå prevent duplicate save
    if (localStorage.getItem("result_saved")) return;

    const name = localStorage.getItem("student_name");
    const studentClass = localStorage.getItem("student_class");

    if (!name || !studentClass) return;

    try {
        await db.collection("aptitudeResults").add({
            name: name,
            class: studentClass,
            totalScore: total,
            categories: categories,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ‚úÖ mark as saved
        localStorage.setItem("result_saved", "true");

        console.log("Result saved to database");
    } catch (error) {
        console.error("Error saving result:", error);
    }
}


    // LOAD RESULTS INTO PAGE
    function loadResults() {

    let total = localStorage.getItem("aptitude_total_score");
    let categories = JSON.parse(localStorage.getItem("aptitude_categories"));
    //saveResultToDB(total, categories);

    if (total === null || categories === null) {
        document.getElementById("resultSection").innerHTML = 
            "<p>No test taken yet. Please complete the aptitude test first.</p>";
        return;
    }
    total = parseInt(total);
    // ‚úÖ save result only after validation
    saveResultToDB(total, categories);

    //total = parseInt(total);

    let message = "";
    if (total >= 12) {
        message = "Excellent aptitude! Strong numerical, logical, and pattern recognition ability.";
    } else if (total >= 7) {
        message = "Good aptitude level. You have solid reasoning and analytical skills.";
    } else {
        message = "Needs improvement. With practice in numerical and logical reasoning, you will progress.";
    }

    document.getElementById("resultSection").innerHTML = `
        <h3>Your Weighted Score: ${total}</h3>
        <p>${message}</p>

        <h4>Category Breakdown:</h4>
        <ul>
            <li><b>Numerical:</b> ${categories.numerical}</li>
            <li><b>Logical:</b> ${categories.logical}</li>
            <li><b>Pattern:</b> ${categories.pattern}</li>
            <li><b>Verbal:</b> ${categories.verbal}</li>
        </ul>
    `;
}

loadResults();


// PDF WITH CHART
async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    
    

    // for printing name,class in pdf 
    let name = localStorage.getItem("student_name") || "N/A";
    let studentClass = localStorage.getItem("student_class") || "N/A";

    let total = localStorage.getItem("aptitude_total_score");
    let categories = JSON.parse(localStorage.getItem("aptitude_categories"));

    let ctx = document.getElementById("chartCanvas").getContext("2d");

    // CREATE BAR CHART
    let chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ["Numerical", "Logical", "Pattern", "Verbal"],
            datasets: [{
                label: "Category Scores",
                data: [
                    categories.numerical,
                    categories.logical,
                    categories.pattern,
                    categories.verbal
                ],
                backgroundColor: ["#4CAF50", "#2196F3", "#FF9800", "#9C27B0"]
            }]
        },
        options: {
            responsive: false,
            animation: {
                duration: 0
            }
        }
    });

    // Convert chart to image
    let chartImage = document.getElementById("chartCanvas").toDataURL("image/png");

    // CREATE PDF
    const doc = new jsPDF();

    // Title
    doc.setFontSize(18);
    doc.text("Aptitude Test Report", 10, 20);
    //printing student details
    doc.setFontSize(12);
    doc.text(`Name: ${name}`, 10, 30);
    doc.text(`Class: ${studentClass}`, 10, 38);


    // Score section
    doc.setFontSize(14);
    doc.text(`Total Weighted Score: ${total}`, 10, 55);

    doc.text("Category Breakdown:", 10, 70);
    doc.setFontSize(12);
    doc.text(`Numerical: ${categories.numerical}`, 10, 80);
    doc.text(`Logical: ${categories.logical}`, 10, 90);
    doc.text(`Pattern: ${categories.pattern}`, 10, 100);
    doc.text(`Verbal: ${categories.verbal}`, 10, 110);

    // Add Chart Image
    doc.addImage(chartImage, "PNG", 10, 125, 180, 100);

    // Save PDF
    doc.save("Aptitude_Report.pdf");

    // Destroy chart instance so it doesn‚Äôt stack
    chart.destroy();
}
function resetAndRetake() {
    localStorage.removeItem("result_saved"); // allow new save
    window.location.href = "tests/aptitude.html";
}

</script>

</body>
</html>
